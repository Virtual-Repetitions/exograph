name: PR Version Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  comment-version-bump:
    runs-on: ubuntu-latest
    steps:
      - name: Comment on version bump
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info("No pull_request in context; skipping.");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: pr.number }
            );
            const cargoChanged = files.some((f) => f.filename === "Cargo.toml");
            if (!cargoChanged) {
              core.info("Cargo.toml not changed; skipping.");
              return;
            }

            async function getVersion(ref) {
              const res = await github.rest.repos.getContent({
                owner,
                repo,
                path: "Cargo.toml",
                ref,
              });
              const content = Buffer.from(res.data.content, "base64").toString("utf8");
              const match = content.match(/^version\s*=\s*"([0-9]+\.[0-9]+\.[0-9]+)"/m);
              return match ? match[1] : null;
            }

            const baseVersion = await getVersion(pr.base.sha);
            const headVersion = await getVersion(pr.head.sha);

            if (!baseVersion || !headVersion) {
              core.info("Unable to determine versions; skipping.");
              return;
            }

            if (baseVersion === headVersion) {
              core.info("Version unchanged; skipping.");
              return;
            }

            const marker = "<!-- version-bump -->";
            const body = `${marker}\nVersion bump detected: \`${baseVersion}\` â†’ \`${headVersion}\``;

            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number: pr.number }
            );
            const existing = comments.find((c) => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
              core.info("Updated existing version bump comment.");
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body,
            });
            core.info("Posted version bump comment.");
